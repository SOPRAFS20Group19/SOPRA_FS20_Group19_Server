<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatabaseConnectorLocationChats.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">soprafs20</a> &gt; <a href="index.source.html" class="el_package">ch.uzh.ifi.seal.soprafs20.database</a> &gt; <span class="el_source">DatabaseConnectorLocationChats.java</span></div><h1>DatabaseConnectorLocationChats.java</h1><pre class="source lang-java linenums">package ch.uzh.ifi.seal.soprafs20.database;
import ch.uzh.ifi.seal.soprafs20.constant.LocationType;
import ch.uzh.ifi.seal.soprafs20.entity.Location;
import ch.uzh.ifi.seal.soprafs20.entity.Message;
import ch.uzh.ifi.seal.soprafs20.entity.User;
import ch.uzh.ifi.seal.soprafs20.exceptions.LocationNotFoundException;
import ch.uzh.ifi.seal.soprafs20.exceptions.UserNotFoundException;
import ch.uzh.ifi.seal.soprafs20.service.LocationService;
import com.mongodb.client.*;
import com.mongodb.client.model.Updates;
import org.bson.Document;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import javax.persistence.criteria.CriteriaBuilder;
import javax.print.Doc;
import java.util.ArrayList;
import java.util.List;

import static com.mongodb.client.model.Filters.*;
import static com.mongodb.client.model.Updates.set;


public class DatabaseConnectorLocationChats {
<span class="nc" id="L26">    public DatabaseConnectorLocationChats() {}</span>

    //connection to mongodb on the cloud with credentials of luca locher
<span class="nc" id="L29">    static MongoClient mongoClient = MongoClients.create(</span>
            &quot;mongodb+srv://lknufi:abc@knowyourcity-ijzn3.gcp.mongodb.net/test?retryWrites=true&amp;w=majority&quot;);
    //Establish connection to the Location Database (development purposes only)
<span class="nc" id="L32">    static MongoDatabase LocationChats = mongoClient.getDatabase(&quot;LocationChats&quot;);</span>
    //Establish connection to the Fountains Collection (development purposes only)
<span class="nc" id="L34">    static MongoCollection&lt;Document&gt; chatsCollection = LocationChats.getCollection(&quot;Chats&quot;);</span>

    // only used for initializing the DB collection. Do not run again
    public static void initialSetup(){
        // set up array for locationIds
<span class="nc" id="L39">        ArrayList&lt;Integer&gt; locationIds = new ArrayList&lt;&gt;();</span>

        // get all locations
<span class="nc" id="L42">        List&lt;Location&gt; allLocations = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L43">        List&lt;Location&gt; listFountains = DatabaseConnectorLocation.getFountains();</span>
<span class="nc" id="L44">        List&lt;Location&gt; listFireplaces = DatabaseConnectorLocation.getFireplaces();</span>
<span class="nc" id="L45">        List&lt;Location&gt; listRecyclingStations = DatabaseConnectorLocation.getRecyclingStations();</span>

<span class="nc" id="L47">        allLocations.addAll(listFountains);</span>
<span class="nc" id="L48">        allLocations.addAll(listFireplaces);</span>
<span class="nc" id="L49">        allLocations.addAll(listRecyclingStations);</span>

        // add all locationsIds to the array
<span class="nc bnc" id="L52" title="All 2 branches missed.">        for (Location location : allLocations){</span>
<span class="nc" id="L53">            locationIds.add(location.getId());</span>
<span class="nc" id="L54">        }</span>

        // insert a doc with an empty chat for each location
<span class="nc bnc" id="L57" title="All 2 branches missed.">        for (Integer id : locationIds){</span>
<span class="nc" id="L58">            ArrayList&lt;Document&gt; emptyChat = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L59">            Document doc = new Document(&quot;locationId&quot;, id)</span>
<span class="nc" id="L60">                    .append(&quot;messages&quot;, emptyChat);</span>
<span class="nc" id="L61">            chatsCollection.insertOne(doc);</span>
<span class="nc" id="L62">        }</span>
<span class="nc" id="L63">    }</span>

    //creates Entry in the database when a new location is created
    public static void addChatForNewLocation(int id){
<span class="nc" id="L67">        ArrayList&lt;Document&gt; emptyChat = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L68">        Document doc = new Document(&quot;locationId&quot;, id)</span>
<span class="nc" id="L69">                .append(&quot;messages&quot;, emptyChat);</span>
<span class="nc" id="L70">        chatsCollection.insertOne(doc);</span>
<span class="nc" id="L71">    }</span>

    public static ArrayList&lt;Message&gt; getChat(Integer locationId){
<span class="nc" id="L74">        FindIterable&lt;Document&gt; request =  chatsCollection.find(eq(&quot;locationId&quot;, locationId));</span>
<span class="nc" id="L75">        Document chatDoc = request.first();</span>

        // throw exception if there is no chat for the given location
<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (chatDoc == null){</span>
<span class="nc" id="L79">            throw new LocationNotFoundException(&quot;This location could not be found&quot;);</span>
        }

<span class="nc" id="L82">        JSONObject chatAsJSON = new JSONObject(chatDoc.toJson());</span>
<span class="nc" id="L83">        JSONArray messagesJSON = chatAsJSON.getJSONArray(&quot;messages&quot;);</span>
<span class="nc" id="L84">        ArrayList&lt;Message&gt; chat = new ArrayList&lt;&gt;();</span>

        // iterate through all message objects in the chat object
<span class="nc bnc" id="L87" title="All 2 branches missed.">        for (int i = 0; i &lt; messagesJSON.length(); i++) {</span>
<span class="nc" id="L88">            JSONObject messageJSON = messagesJSON.getJSONObject(i);</span>
            // convert the messageJSON to the Message entity type
<span class="nc" id="L90">            chat.add(convertMessageJSONToEntity(messageJSON));</span>
        }

<span class="nc" id="L93">        return chat;</span>
    }

    public static void postMessage(Integer locationId, Message message){
<span class="nc" id="L97">        Document doc = new Document(&quot;senderId&quot;, message.getSenderId())</span>
<span class="nc" id="L98">                .append(&quot;content&quot;, message.getContent())</span>
<span class="nc" id="L99">                .append(&quot;timestamp&quot;, message.getTimestamp())</span>
<span class="nc" id="L100">                .append(&quot;messageId&quot;, generateId(locationId));</span>

<span class="nc" id="L102">        chatsCollection.updateOne(eq(&quot;locationId&quot;, locationId), Updates.addToSet(&quot;messages&quot;, doc));</span>
<span class="nc" id="L103">    }</span>

    //Helper function which generates a unique message id that is not taken yet by a message for this location chat
    public static int generateId(int locationId){
<span class="nc" id="L107">        FindIterable&lt;Document&gt; request = chatsCollection.find(eq(&quot;locationId&quot;, locationId));</span>
<span class="nc" id="L108">        Document chatDoc = request.first();</span>
<span class="nc" id="L109">        JSONObject chatAsJSON = new JSONObject(chatDoc.toJson());</span>
<span class="nc" id="L110">        JSONArray messagesJSON = chatAsJSON.getJSONArray(&quot;messages&quot;);</span>

<span class="nc" id="L112">        int random = (int) (Math.random() * 100000);</span>

<span class="nc bnc" id="L114" title="All 2 branches missed.">        for (int i = 0; i &lt; messagesJSON.length(); i++) {</span>
<span class="nc" id="L115">            JSONObject messageJSON = messagesJSON.getJSONObject(i);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">            if (messageJSON.getInt(&quot;messageId&quot;) == random){</span>
<span class="nc" id="L117">                random = generateId(locationId);</span>
            }
        }

<span class="nc" id="L121">        return random;</span>
    }

    public static void deleteMessage(Integer locationId, int messageId){
<span class="nc" id="L125">        FindIterable&lt;Document&gt; request =  chatsCollection.find(eq(&quot;locationId&quot;, locationId));</span>
<span class="nc" id="L126">        Document chatDoc = request.first();</span>
<span class="nc" id="L127">        JSONObject chatAsJSON = new JSONObject(chatDoc.toJson());</span>
<span class="nc" id="L128">        JSONArray messagesJSON = chatAsJSON.getJSONArray(&quot;messages&quot;);</span>

<span class="nc" id="L130">        Message messageToRemove = new Message();</span>

<span class="nc bnc" id="L132" title="All 2 branches missed.">        for (int i = 0; i &lt; messagesJSON.length(); i++) {</span>
<span class="nc" id="L133">            JSONObject messageJSON = messagesJSON.getJSONObject(i);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">            if (messageJSON.getInt(&quot;messageId&quot;) == messageId){</span>
<span class="nc" id="L135">                messageToRemove = convertMessageJSONToEntity(messageJSON);</span>
            }
        }

<span class="nc" id="L139">        chatsCollection.updateOne(eq(&quot;locationId&quot;, locationId),</span>
<span class="nc" id="L140">                Updates.pull(&quot;messages&quot;, convertEntityToDocument(messageToRemove)));</span>
<span class="nc" id="L141">    }</span>

    public static Message convertMessageJSONToEntity(JSONObject messageJSON){
<span class="nc" id="L144">        Message message = new Message();</span>

<span class="nc" id="L146">        int userId = messageJSON.getInt(&quot;senderId&quot;);</span>

<span class="nc" id="L148">        message.setSenderUsername(DatabaseConnectorUser.getUsernameById(userId));</span>
<span class="nc" id="L149">        message.setSenderId(userId);</span>
<span class="nc" id="L150">        message.setContent(messageJSON.getString(&quot;content&quot;));</span>
<span class="nc" id="L151">        message.setTimestamp(messageJSON.getString(&quot;timestamp&quot;));</span>
<span class="nc" id="L152">        message.setMessageId(messageJSON.getInt(&quot;messageId&quot;));</span>

<span class="nc" id="L154">        return message;</span>
    }

    public static Document convertEntityToDocument(Message message){
<span class="nc" id="L158">        return new Document(&quot;senderId&quot;, message.getSenderId())</span>
<span class="nc" id="L159">                .append(&quot;content&quot;, message.getContent())</span>
<span class="nc" id="L160">                .append(&quot;timestamp&quot;, message.getTimestamp())</span>
<span class="nc" id="L161">                .append(&quot;messageId&quot;, message.getMessageId());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>