<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LocationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">soprafs20</a> &gt; <a href="index.source.html" class="el_package">ch.uzh.ifi.seal.soprafs20.service</a> &gt; <span class="el_source">LocationService.java</span></div><h1>LocationService.java</h1><pre class="source lang-java linenums">package ch.uzh.ifi.seal.soprafs20.service;

import ch.uzh.ifi.seal.soprafs20.database.DatabaseConnectorFavoriteLocations;
import ch.uzh.ifi.seal.soprafs20.database.DatabaseConnectorLocation;
import ch.uzh.ifi.seal.soprafs20.database.DatabaseConnectorLocationChats;
import ch.uzh.ifi.seal.soprafs20.database.DatabaseConnectorRating;
import ch.uzh.ifi.seal.soprafs20.entity.Location;
import ch.uzh.ifi.seal.soprafs20.entity.Message;
import ch.uzh.ifi.seal.soprafs20.exceptions.*;
import ch.uzh.ifi.seal.soprafs20.rest.dto.FilterPostDTO;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;

import java.text.SimpleDateFormat;
import java.sql.Timestamp;

/**
 * Location Service
 * This class is the &quot;worker&quot; and responsible for all functionality related to the location
 * (e.g., it creates, modifies, deletes, finds). The result will be passed back to the caller.
 */
@Service
@Transactional
public class LocationService {

<span class="fc" id="L31">    private final Logger log = LoggerFactory.getLogger(LocationService.class);</span>

<span class="fc" id="L33">    public LocationService(){}</span>

    public List&lt;Location&gt; getLocations(){
<span class="fc" id="L36">        List&lt;Location&gt; allLocations = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L37">        List&lt;Location&gt; listFountains = DatabaseConnectorLocation.getFountains();</span>
<span class="fc" id="L38">        List&lt;Location&gt; listFireplaces = DatabaseConnectorLocation.getFireplaces();</span>
<span class="fc" id="L39">        List&lt;Location&gt; listRecyclingStations = DatabaseConnectorLocation.getRecyclingStations();</span>
<span class="fc" id="L40">        List&lt;Location&gt; listUserFountains = DatabaseConnectorLocation.getUserFountains();</span>
<span class="fc" id="L41">        List&lt;Location&gt; listUserFireplaces = DatabaseConnectorLocation.getUserFireplaces();</span>
<span class="fc" id="L42">        List&lt;Location&gt; listUserRecycling = DatabaseConnectorLocation.getUserRecycling();</span>

<span class="fc" id="L44">        allLocations.addAll(listFountains);</span>
<span class="fc" id="L45">        allLocations.addAll(listFireplaces);</span>
<span class="fc" id="L46">        allLocations.addAll(listRecyclingStations);</span>
<span class="fc" id="L47">        allLocations.addAll(listUserFountains);</span>
<span class="fc" id="L48">        allLocations.addAll(listUserFireplaces);</span>
<span class="fc" id="L49">        allLocations.addAll(listUserRecycling);</span>

<span class="fc" id="L51">        return allLocations;</span>
    }

    public List&lt;Location&gt; getFilteredLocations(FilterPostDTO filterPostDTO) {
<span class="nc" id="L55">        List&lt;Location&gt; filteredLocations = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (filterPostDTO.showFountains()){</span>
<span class="nc" id="L57">            List&lt;Location&gt; listFountains = DatabaseConnectorLocation.getFountains();</span>
<span class="nc" id="L58">            List&lt;Location&gt; listUserFountains = DatabaseConnectorLocation.getUserFountains();</span>
<span class="nc" id="L59">            filteredLocations.addAll(listFountains);</span>
<span class="nc" id="L60">            filteredLocations.addAll(listUserFountains);</span>
        }
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (filterPostDTO.showFireplaces()){</span>
<span class="nc" id="L63">            List&lt;Location&gt; listFireplaces = DatabaseConnectorLocation.getFireplaces();</span>
<span class="nc" id="L64">            List&lt;Location&gt; listUserFireplaces = DatabaseConnectorLocation.getUserFireplaces();</span>
<span class="nc" id="L65">            filteredLocations.addAll(listFireplaces);</span>
<span class="nc" id="L66">            filteredLocations.addAll(listUserFireplaces);</span>

        }
<span class="nc bnc" id="L69" title="All 2 branches missed.">        if (filterPostDTO.showRecyclingStations()){</span>
<span class="nc" id="L70">            List&lt;Location&gt; listRecyclingStations = DatabaseConnectorLocation.getRecyclingStations();</span>
<span class="nc" id="L71">            List&lt;Location&gt; listUserRecyclingStations = DatabaseConnectorLocation.getUserRecycling();</span>
<span class="nc" id="L72">            filteredLocations.addAll(listRecyclingStations);</span>
<span class="nc" id="L73">            filteredLocations.addAll(listUserRecyclingStations);</span>

        }

<span class="nc" id="L77">        return filteredLocations;</span>
    }

    public Location getLocation(int id){
<span class="fc" id="L81">        List&lt;Location&gt; allLocations = this.getLocations();</span>

<span class="fc" id="L83">        Location locationToReturn = null;</span>

<span class="fc bfc" id="L85" title="All 2 branches covered.">        for (Location location: allLocations){</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">            if (id == (location.getId())){</span>
<span class="fc" id="L87">                locationToReturn = location;</span>
            }
<span class="fc" id="L89">        }</span>

<span class="fc bfc" id="L91" title="All 2 branches covered.">        if (locationToReturn == null){</span>
<span class="fc" id="L92">            throw new LocationNotFoundException(&quot;This location could not be found.&quot;);</span>
        }

<span class="fc" id="L95">        return locationToReturn;</span>
    }

    public Location createLocation(Location newLocation){
<span class="fc" id="L99">        int newLocationId = DatabaseConnectorLocation.createLocation(newLocation);</span>
        //ADD TO CHAT -&gt; IMPORTANT! sp√§ter die Kommentarfunktion entfernen, LK: auskommentiert am 27.04
<span class="fc" id="L101">        DatabaseConnectorLocationChats.addChatForNewLocation(newLocationId);</span>
<span class="fc" id="L102">        Location locationToReturn = this.getLocation(newLocationId);</span>
<span class="fc" id="L103">        return locationToReturn;</span>
    }

    public void updateLocation(Location location){
<span class="nc" id="L107">    }</span>

    public ArrayList&lt;Message&gt; getChat(Integer locationId){
<span class="nc" id="L110">        return DatabaseConnectorLocationChats.getChat(locationId);</span>
    }

    public void postMessage(Integer locationId, Message message){
<span class="nc" id="L114">        message.setTimestamp(getCurrentTimestamp());</span>
<span class="nc" id="L115">        DatabaseConnectorLocationChats.postMessage(locationId, message);</span>
<span class="nc" id="L116">    }</span>

    // gets a users favorite locations
    public List&lt;Location&gt; getFavoriteLocations(int userId){
<span class="nc" id="L120">        ArrayList&lt;Integer&gt; favoriteLocationIds = DatabaseConnectorFavoriteLocations.getFavoriteLocations(userId);</span>
<span class="nc" id="L121">        List&lt;Location&gt; locationsToReturn = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">        for (Integer locationId : favoriteLocationIds){</span>
<span class="nc" id="L123">            locationsToReturn.add(this.getLocation(locationId));</span>
<span class="nc" id="L124">        }</span>
<span class="nc" id="L125">        return locationsToReturn;</span>
    }

    public void updateFavoriteLocations(int userId, Integer locationId){
<span class="nc" id="L129">        ArrayList&lt;Integer&gt; favorites = DatabaseConnectorFavoriteLocations.getFavoriteLocations(userId);</span>
<span class="nc" id="L130">        ArrayList&lt;Integer&gt; newFavorites = new ArrayList&lt;&gt;(favorites);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (!favorites.contains(locationId)){</span>
<span class="nc" id="L132">            newFavorites.add(locationId);</span>
        }
<span class="nc" id="L134">        DatabaseConnectorFavoriteLocations.updateFavoriteLocations(userId, newFavorites);</span>
<span class="nc" id="L135">    }</span>

    public void deleteFavoriteLocation(int userId, Integer locationId){
<span class="nc" id="L138">        ArrayList&lt;Integer&gt; favorites = DatabaseConnectorFavoriteLocations.getFavoriteLocations(userId);</span>
<span class="nc" id="L139">        ArrayList&lt;Integer&gt; newFavorites = new ArrayList&lt;&gt;(favorites);</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (favorites.contains(locationId)){</span>
<span class="nc" id="L141">            newFavorites.remove(locationId);</span>
        }
<span class="nc" id="L143">        DatabaseConnectorFavoriteLocations.updateFavoriteLocations(userId, newFavorites);</span>
<span class="nc" id="L144">    }</span>

    public Location checkFavoriteLocations(int userId, Integer locationId){
<span class="nc" id="L147">        ArrayList&lt;Integer&gt; favoriteLocationIds = DatabaseConnectorFavoriteLocations.getFavoriteLocations(userId);</span>
<span class="nc" id="L148">        Location locationToReturn = null;</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        for (Integer locationIdToCheck : favoriteLocationIds){</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">            if (locationId.equals(locationIdToCheck)){</span>
<span class="nc" id="L151">                locationToReturn = this.getLocation(locationId);</span>
            }
<span class="nc" id="L153">        }</span>
<span class="nc" id="L154">        return locationToReturn;</span>
    }

    public int checkRating(int userId, Integer locationId){
        //implement the function
<span class="nc" id="L159">        return DatabaseConnectorRating.getRating(userId,locationId);</span>

    }

    public double checkAverageRating(Integer locationId){
<span class="nc" id="L164">        return DatabaseConnectorRating.getAverageRating(locationId);</span>
    }


    public static void updateRating(int userId, Integer locationId, int rating){
<span class="nc" id="L169">        DatabaseConnectorRating.updateRating(userId, locationId, rating);</span>
<span class="nc" id="L170">    }</span>

    public String getCurrentTimestamp(){
<span class="nc" id="L173">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;dd.MM, HH:mm&quot;);</span>
<span class="nc" id="L174">        Timestamp timestamp = new Timestamp(System.currentTimeMillis());</span>
<span class="nc" id="L175">        return sdf.format(timestamp);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>