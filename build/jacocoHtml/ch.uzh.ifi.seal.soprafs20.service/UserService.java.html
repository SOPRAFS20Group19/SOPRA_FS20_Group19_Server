<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">soprafs20</a> &gt; <a href="index.source.html" class="el_package">ch.uzh.ifi.seal.soprafs20.service</a> &gt; <span class="el_source">UserService.java</span></div><h1>UserService.java</h1><pre class="source lang-java linenums">package ch.uzh.ifi.seal.soprafs20.service;

import ch.uzh.ifi.seal.soprafs20.constant.UserStatus;
import ch.uzh.ifi.seal.soprafs20.database.DatabaseConnector;
import ch.uzh.ifi.seal.soprafs20.database.DatabaseConnectorUser;
import ch.uzh.ifi.seal.soprafs20.entity.Location;
import ch.uzh.ifi.seal.soprafs20.service.LocationService;
import ch.uzh.ifi.seal.soprafs20.entity.User;
import ch.uzh.ifi.seal.soprafs20.exceptions.DuplicatedUserException;
import ch.uzh.ifi.seal.soprafs20.exceptions.InvalidCredentialsException;
import ch.uzh.ifi.seal.soprafs20.exceptions.SopraServiceException;
import ch.uzh.ifi.seal.soprafs20.exceptions.UserNotFoundException;
import ch.uzh.ifi.seal.soprafs20.rest.dto.UserPutDTO;
import org.hibernate.dialect.Database;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.server.ResponseStatusException;

import javax.xml.crypto.Data;
import java.sql.Timestamp;

import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.time.Instant;
import java.time.LocalDate;
import java.util.*;

/**
 * User Service
 * This class is the &quot;worker&quot; and responsible for all functionality related to the user
 * (e.g., it creates, modifies, deletes, finds). The result will be passed back to the caller.
 */
@Service
@Transactional
<span class="fc" id="L40">public class UserService {</span>

<span class="fc" id="L42">    private final Logger log = LoggerFactory.getLogger(UserService.class);</span>


    // returns a user in the repository identified by his ID
    public User getUserById(int id){
        //Not yet implemented
<span class="nc" id="L48">        User userToReturn = DatabaseConnectorUser.getUserById(id);</span>
<span class="nc" id="L49">        return  userToReturn;</span>
    }

    // updates a user with the updated name, username and password
    public void updateUser(int userId, UserPutDTO userWithNewData) {
<span class="nc" id="L54">        User userToUpdate = DatabaseConnectorUser.getUserById(userId);</span>

<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (userToUpdate == null){</span>
<span class="nc" id="L57">            throw new UserNotFoundException(&quot;This user could not be found.&quot;);</span>
        }

<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (userWithNewData.getName() != null){</span>
<span class="nc" id="L61">            userToUpdate.setName(userWithNewData.getName());</span>
<span class="nc" id="L62">            DatabaseConnectorUser.updateName(userToUpdate);</span>
        }

<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (userWithNewData.getUsername() != null){</span>
<span class="nc" id="L66">            userToUpdate.setUsername(userWithNewData.getUsername());</span>
<span class="nc" id="L67">            DatabaseConnectorUser.updateUsername(userToUpdate);</span>
        }

<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (userWithNewData.getPassword() != null){</span>
<span class="nc" id="L71">            userToUpdate.setPassword(userWithNewData.getPassword());</span>
<span class="nc" id="L72">            DatabaseConnectorUser.updatePassword(userToUpdate);</span>
        }

<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (userWithNewData.getAvatarNr() != 0){</span>
<span class="nc" id="L76">            userToUpdate.setAvatarNr(userWithNewData.getAvatarNr());</span>
<span class="nc" id="L77">            DatabaseConnectorUser.updateAvatarNr(userToUpdate);</span>
        }

<span class="nc" id="L80">    }</span>

    // logs out the user
    public void logoutUser(int id){
<span class="nc" id="L84">        DatabaseConnectorUser.setOnlineStatusById(id, false);</span>
<span class="nc" id="L85">    }</span>

    // checks if the user that is attempting a login has the correct credentials
    public User checkForLogin(User userToBeLoggedIn) {

<span class="nc" id="L90">        boolean validCredentials = DatabaseConnectorUser.checkIfUserAndPasswordExist(userToBeLoggedIn.getUsername(), userToBeLoggedIn.getPassword());</span>

        //Check if user is allowed to log in
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (!validCredentials) { //case that the credentials are invalid</span>
<span class="nc" id="L94">            boolean validUsername = DatabaseConnectorUser.checkIfUsernameExists(userToBeLoggedIn.getUsername());</span>
            //check if the username is valid, if yes, the password must be false
<span class="nc bnc" id="L96" title="All 2 branches missed.">            String message = validUsername ? &quot;Wrong password, please try again.&quot; : &quot;This username does not exist, please register first.&quot;;</span>
<span class="nc" id="L97">            throw new InvalidCredentialsException(message);</span>
        }

        //If credentials are valid set the user status to online, since the user will be logged in
<span class="nc" id="L101">        DatabaseConnectorUser.setOnlineStatus(userToBeLoggedIn, true);</span>
        //return new user representation
<span class="nc" id="L103">        User user = DatabaseConnectorUser.getUserByUsername(userToBeLoggedIn.getUsername());</span>

<span class="nc" id="L105">        return user;</span>
    }

    // creates a new user in the user repository
    public User createUser(User newUser) {
<span class="nc" id="L110">        newUser.setCreationDate(UserService.getCurrentDate());</span>
<span class="nc" id="L111">        newUser.setFavoriteLocations(new ArrayList&lt;Integer&gt;());</span>
        //Checks whether username is already taken
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (DatabaseConnectorUser.checkIfUsernameExists(newUser.getUsername())){</span>
<span class="nc" id="L114">            throw new DuplicatedUserException(&quot;The provided username is already taken. Please try a new one.&quot;);</span>
        }
        //If the username is not already taken create a new User in the database
<span class="nc" id="L117">        User userToReturn = DatabaseConnectorUser.createUser(newUser);</span>

<span class="nc" id="L119">        log.debug(&quot;Created Information for User: {}&quot;, newUser);</span>

<span class="nc" id="L121">        return userToReturn;</span>
    }

    // creates a timestamp of the current date for the creation date during the registration
    public static String getCurrentDate(){

<span class="nc" id="L127">        Date datenow = Calendar.getInstance().getTime();</span>
<span class="nc" id="L128">        DateFormat dateFormat = new SimpleDateFormat(&quot;dd.MM.yyyy&quot;);</span>
<span class="nc" id="L129">        Timestamp timestamp = new Timestamp(System.currentTimeMillis());</span>
<span class="nc" id="L130">        LocalDate date = LocalDate.now();</span>
        //return date.toString();
<span class="nc" id="L132">        return dateFormat.format(datenow);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>