<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatabaseConnector.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">soprafs20</a> &gt; <a href="index.source.html" class="el_package">ch.uzh.ifi.seal.soprafs20.database</a> &gt; <span class="el_source">DatabaseConnector.java</span></div><h1>DatabaseConnector.java</h1><pre class="source lang-java linenums">package ch.uzh.ifi.seal.soprafs20.database;


import ch.uzh.ifi.seal.soprafs20.constant.LocationType;
import ch.uzh.ifi.seal.soprafs20.constant.UserStatus;
import ch.uzh.ifi.seal.soprafs20.entity.Location;
import ch.uzh.ifi.seal.soprafs20.entity.User;
import com.mongodb.*;
import com.mongodb.client.*;

import com.mongodb.client.MongoClient;
import com.mongodb.MongoClientURI;
import com.mongodb.ServerAddress;
import com.mongodb.client.MongoDatabase;
import com.mongodb.client.MongoCollection;
import com.mongodb.Block;

import com.mongodb.client.MongoCursor;
import org.bson.Document;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import java.lang.reflect.Array;
import java.util.Arrays;

import static com.mongodb.client.model.Filters.*;
import com.mongodb.client.result.DeleteResult;
import static com.mongodb.client.model.Updates.*;
import com.mongodb.client.result.UpdateResult;
import java.util.ArrayList;
import java.util.List;





public class DatabaseConnector {

<span class="nc" id="L40">    public DatabaseConnector(){}</span>


    //connection to mongodb on the cloud with credentials of luca locher
<span class="nc" id="L44">    static MongoClient mongoClient = MongoClients.create(</span>
            &quot;mongodb+srv://lknufi:abc@knowyourcity-ijzn3.gcp.mongodb.net/test?retryWrites=true&amp;w=majority&quot;);
    //Establish connection to the Users Database (development purposes only)
<span class="nc" id="L47">    static MongoDatabase usersDevelopment = mongoClient.getDatabase(&quot;UsersDevelopment&quot;);</span>
    //Establish connection to the Users Collection (development purposes only)
<span class="nc" id="L49">    static MongoCollection&lt;Document&gt; usersCollection = usersDevelopment.getCollection(&quot;Users&quot;);</span>

    //Establish connection to the Location Database (development purposes only)
<span class="nc" id="L52">    static MongoDatabase locationStorage = mongoClient.getDatabase(&quot;LocationStorage&quot;);</span>
    //Establish connection to the Fountains Collection (development purposes only)
<span class="nc" id="L54">    static MongoCollection&lt;Document&gt; fountainsCollection = locationStorage.getCollection(&quot;Fountains&quot;);</span>
    //Establish connection to the Fireplaces Collection (development purposes only)
<span class="nc" id="L56">    static MongoCollection&lt;Document&gt; fireplacesCollection = locationStorage.getCollection(&quot;Fireplaces&quot;);</span>
    //Establish connection to the Recycling Collection (development purposes only)
<span class="nc" id="L58">    static MongoCollection&lt;Document&gt; recyclingCollection = locationStorage.getCollection(&quot;Recycling&quot;);</span>


    //creates User in the database; called bi createUser() in UserService
    public static void createUser(User user) {

<span class="nc" id="L64">         Document doc = new Document(&quot;username&quot;, user.getUsername())</span>
<span class="nc" id="L65">                                    .append(&quot;name&quot;, user.getName())</span>
<span class="nc" id="L66">                                    .append(&quot;password&quot;, user.getPassword())</span>
<span class="nc" id="L67">                                    .append(&quot;creation-date&quot;, user.getCreationDate())</span>
<span class="nc" id="L68">                                    .append(&quot;online&quot;, false);</span>
<span class="nc" id="L69">         usersCollection.insertOne(doc);</span>
<span class="nc" id="L70">    }</span>

    //Checks if user tried to login with valid credentials
    public static boolean checkIfUserAndPasswordExist(String username, String password){
<span class="nc" id="L74">        FindIterable&lt;Document&gt; request = usersCollection.find(and(eq(&quot;username&quot;, username), eq(&quot;password&quot;, password)));</span>
<span class="nc" id="L75">        Document user = request.first();</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (user == null){</span>
<span class="nc" id="L77">            return false;</span>
        }
<span class="nc" id="L79">        return true;</span>
    }

    //checks if user provided a valid username
    public static boolean checkIfUsernameExists(String username){
<span class="nc" id="L84">        FindIterable&lt;Document&gt; request = usersCollection.find(eq(&quot;username&quot;, username));</span>
<span class="nc" id="L85">        Document user = request.first();</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (user == null){</span>
<span class="nc" id="L87">            return false;</span>
        }
<span class="nc" id="L89">        return true;</span>
    }

    //returns a user with a certain username
    public static User getUserByUsername(String username){
<span class="nc" id="L94">        FindIterable&lt;Document&gt; request =  usersCollection.find(eq(&quot;username&quot;, username));</span>
<span class="nc" id="L95">        Document user = request.first();</span>
        //create a new user representation
<span class="nc" id="L97">        User userRepresentation = DatabaseConnector.getUserInfo(user);</span>
<span class="nc" id="L98">        return userRepresentation;</span>
    }

    //transforms BSON User into Backend User Representation
    public static User getUserInfo(Document user){
<span class="nc" id="L103">        User userRepresentation = new User();</span>
<span class="nc" id="L104">        userRepresentation.setUsername(user.getString(&quot;username&quot;));</span>
<span class="nc" id="L105">        userRepresentation.setName(user.getString(&quot;name&quot;));</span>
<span class="nc" id="L106">        userRepresentation.setPassword(user.getString(&quot;password&quot;));</span>
<span class="nc" id="L107">        userRepresentation.setCreationDate(user.getString(&quot;creation-date&quot;));</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">        userRepresentation.setStatus(user.getBoolean(&quot;online&quot;)? UserStatus.ONLINE : UserStatus.OFFLINE);</span>
<span class="nc" id="L109">        return userRepresentation;</span>
    }

    //returns all users represented as User.class
    public static List&lt;User&gt; getAllUsers(){
<span class="nc" id="L114">        List&lt;Document&gt; request = usersCollection.find().into(new ArrayList&lt;&gt;());</span>
<span class="nc" id="L115">        List&lt;User&gt; allUsers = new ArrayList&lt;User&gt;();</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">        for (Document doc : request){</span>
<span class="nc" id="L117">            User tempUser = DatabaseConnector.getUserInfo(doc);</span>
<span class="nc" id="L118">            allUsers.add(tempUser);</span>
<span class="nc" id="L119">        }</span>
<span class="nc" id="L120">        return allUsers;</span>


    }

    public static void getFountainById(int id){
<span class="nc" id="L126">        Document fountainOne = fountainsCollection.find().first();</span>

        //Document fountain = (Document) fountainsCollection.find(eq(&quot;properties.objectid&quot;, id));
        //return fountainToLocation(fountainOne);
<span class="nc" id="L130">    }</span>

    public static List&lt;Location&gt; getFountains() throws JSONException {
<span class="nc" id="L133">        List&lt;Document&gt; fountainsList = fountainsCollection.find().into(new ArrayList&lt;&gt;());</span>
<span class="nc" id="L134">        List&lt;Location&gt; fountainsListLocation = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">        for (Document fountain : fountainsList) {</span>
<span class="nc" id="L136">            String fountainAsString = fountain.toJson();</span>
<span class="nc" id="L137">            JSONObject fountainAsJson = new JSONObject(fountainAsString);</span>
            //convert Document to Location
<span class="nc" id="L139">            Location fountainLocation = fountainToLocation(fountainAsJson);</span>
            //add Location to List of Locations
<span class="nc" id="L141">            fountainsListLocation.add(fountainLocation);</span>
<span class="nc" id="L142">        }</span>
<span class="nc" id="L143">        return fountainsListLocation;</span>
    }

    public static List&lt;Location&gt; getFireplaces(){
<span class="nc" id="L147">        List&lt;Document&gt; fireplacesList = fireplacesCollection.find().into(new ArrayList&lt;&gt;());</span>
<span class="nc" id="L148">        List&lt;Location&gt; fireplacesListLocation = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        for (Document fireplace: fireplacesList){</span>
<span class="nc" id="L150">            String fireplaceAsString = fireplace.toJson();</span>
<span class="nc" id="L151">            JSONObject fireplaceAsJSON = new JSONObject(fireplaceAsString);</span>
            //convert Document to Location
<span class="nc" id="L153">            Location fireplaceLocation = fireplaceToLocation(fireplaceAsJSON);</span>
            //add Location to List of Locations
<span class="nc" id="L155">            fireplacesListLocation.add(fireplaceLocation);</span>
<span class="nc" id="L156">        }</span>
<span class="nc" id="L157">        return fireplacesListLocation;</span>
    }

    public static List&lt;Location&gt; getRecyclingStations(){
<span class="nc" id="L161">        List&lt;Document&gt; recyclingList = recyclingCollection.find().into(new ArrayList&lt;&gt;());</span>
<span class="nc" id="L162">        List&lt;Location&gt; recyclingListLocation = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        for (Document recyclingStation: recyclingList){</span>
<span class="nc" id="L164">            String recyclingAsString = recyclingStation.toJson();</span>
<span class="nc" id="L165">            JSONObject recyclingAsJSON = new JSONObject(recyclingAsString);</span>
            //convert Document to Location
<span class="nc" id="L167">            Location recyclingLocation = recyclingToLocation(recyclingAsJSON);</span>
            //add Location to List of Locations
<span class="nc" id="L169">            recyclingListLocation.add(recyclingLocation);</span>
<span class="nc" id="L170">        }</span>
<span class="nc" id="L171">        return recyclingListLocation;</span>
    }

    public static Location fountainToLocation(JSONObject fountainAsJson) throws JSONException {
<span class="nc" id="L175">        Location newLocation = new Location();</span>

<span class="nc" id="L177">        JSONObject properties = fountainAsJson.getJSONObject(&quot;properties&quot;);</span>
<span class="nc" id="L178">        JSONObject geometry = fountainAsJson.getJSONObject(&quot;geometry&quot;);</span>

<span class="nc" id="L180">        newLocation.setId(properties.getInt(&quot;objectid&quot;));</span>

<span class="nc" id="L182">        JSONArray coordinatesAsJSON = (JSONArray) geometry.get(&quot;coordinates&quot;);</span>
<span class="nc" id="L183">        double lat = coordinatesAsJSON.getDouble(1);</span>
<span class="nc" id="L184">        double lon = coordinatesAsJSON.getDouble(0);</span>
<span class="nc" id="L185">        double[] coordinates = {lon, lat};</span>
<span class="nc" id="L186">        newLocation.setCoordinates(coordinates);</span>
<span class="nc" id="L187">        newLocation.setLocationType(LocationType.FOUNTAIN);</span>
<span class="nc" id="L188">        return newLocation;</span>
    }

    public static Location fireplaceToLocation(JSONObject fireplaceAsJSON){
<span class="nc" id="L192">        Location newLocation = new Location();</span>

<span class="nc" id="L194">        JSONObject barbecuePlace = fireplaceAsJSON.getJSONObject(&quot;BarbecuePlace&quot;);</span>

<span class="nc" id="L196">        newLocation.setId(barbecuePlace.getInt(&quot;Id&quot;));</span>
<span class="nc" id="L197">        double lat = barbecuePlace.getDouble(&quot;Latitude&quot;);</span>
<span class="nc" id="L198">        double lon = barbecuePlace.getDouble(&quot;Longitude&quot;);</span>
<span class="nc" id="L199">        double[] coordinates = {lon, lat};</span>
<span class="nc" id="L200">        newLocation.setCoordinates(coordinates);</span>
<span class="nc" id="L201">        newLocation.setLocationType(LocationType.FIREPLACE);</span>
<span class="nc" id="L202">        return newLocation;</span>
    }

    public static Location recyclingToLocation(JSONObject recyclingAsJSON){
<span class="nc" id="L206">        Location newLocation = new Location();</span>

<span class="nc" id="L208">        JSONObject properties = recyclingAsJSON.getJSONObject(&quot;properties&quot;);</span>
<span class="nc" id="L209">        JSONObject geometry = recyclingAsJSON.getJSONObject(&quot;geometry&quot;);</span>
<span class="nc" id="L210">        JSONArray coordinatesAsJSON = (JSONArray) geometry.get(&quot;coordinates&quot;);</span>

<span class="nc" id="L212">        newLocation.setId(Integer.parseInt(properties.getString(&quot;objectid&quot;)));</span>
<span class="nc" id="L213">        double lat = coordinatesAsJSON.getDouble(1);</span>
<span class="nc" id="L214">        double lon = coordinatesAsJSON.getDouble(0);</span>
<span class="nc" id="L215">        double[] coordinates = {lon, lat};</span>
<span class="nc" id="L216">        newLocation.setCoordinates(coordinates);</span>
<span class="nc" id="L217">        newLocation.setLocationType(LocationType.RECYCLING_STATION);</span>
<span class="nc" id="L218">        return newLocation;</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>