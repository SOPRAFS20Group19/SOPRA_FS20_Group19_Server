<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">soprafs20</a> &gt; <a href="index.source.html" class="el_package">ch.uzh.ifi.seal.soprafs20.service</a> &gt; <span class="el_source">UserService.java</span></div><h1>UserService.java</h1><pre class="source lang-java linenums">package ch.uzh.ifi.seal.soprafs20.service;

import ch.uzh.ifi.seal.soprafs20.database.DatabaseConnectorUser;
import ch.uzh.ifi.seal.soprafs20.entity.User;
import ch.uzh.ifi.seal.soprafs20.exceptions.DuplicatedUserException;
import ch.uzh.ifi.seal.soprafs20.exceptions.InvalidCredentialsException;
import ch.uzh.ifi.seal.soprafs20.exceptions.UserNotFoundException;
import ch.uzh.ifi.seal.soprafs20.rest.dto.UserPutDTO;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.sql.Timestamp;

import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.time.LocalDate;
import java.util.*;

/**
 * User Service
 * This class is the &quot;worker&quot; and responsible for all functionality related to the user
 * (e.g., it creates, modifies, deletes, finds). The result will be passed back to the caller.
 */
@Service
@Transactional
<span class="fc" id="L28">public class UserService {</span>

<span class="fc" id="L30">    private final Logger log = LoggerFactory.getLogger(UserService.class);</span>


    // returns a user in the repository identified by his ID
    public User getUserById(int id){
        //Not yet implemented
<span class="fc" id="L36">        User userToReturn = DatabaseConnectorUser.getUserById(id);</span>
<span class="fc" id="L37">        return  userToReturn;</span>
    }

    // updates a user with the updated name, username and password
    public void updateUser(int userId, UserPutDTO userWithNewData) {
<span class="fc" id="L42">        User userToUpdate = DatabaseConnectorUser.getUserById(userId);</span>

<span class="pc bpc" id="L44" title="1 of 2 branches missed.">        if (userToUpdate == null){</span>
<span class="nc" id="L45">            throw new UserNotFoundException(&quot;This user could not be found.&quot;);</span>
        }

<span class="pc bpc" id="L48" title="1 of 2 branches missed.">        if (userWithNewData.getName() != null){</span>
<span class="fc" id="L49">            userToUpdate.setName(userWithNewData.getName());</span>
<span class="fc" id="L50">            DatabaseConnectorUser.updateName(userToUpdate);</span>
        }

<span class="pc bpc" id="L53" title="1 of 2 branches missed.">        if (userWithNewData.getUsername() != null){</span>
<span class="fc" id="L54">            userToUpdate.setUsername(userWithNewData.getUsername());</span>
<span class="fc" id="L55">            DatabaseConnectorUser.updateUsername(userToUpdate);</span>
        }

<span class="pc bpc" id="L58" title="1 of 2 branches missed.">        if (userWithNewData.getPassword() != null){</span>
<span class="fc" id="L59">            userToUpdate.setPassword(userWithNewData.getPassword());</span>
<span class="fc" id="L60">            DatabaseConnectorUser.updatePassword(userToUpdate);</span>
        }

<span class="pc bpc" id="L63" title="1 of 2 branches missed.">        if (userWithNewData.getAvatarNr() != 0){</span>
<span class="nc" id="L64">            userToUpdate.setAvatarNr(userWithNewData.getAvatarNr());</span>
<span class="nc" id="L65">            DatabaseConnectorUser.updateAvatarNr(userToUpdate);</span>
        }

<span class="fc" id="L68">    }</span>

    // logs out the user
    public void logoutUser(int id){
<span class="fc" id="L72">        DatabaseConnectorUser.setOnlineStatusById(id, false);</span>
<span class="fc" id="L73">    }</span>

    // checks if the user that is attempting a login has the correct credentials
    public User checkForLogin(User userToBeLoggedIn) {

<span class="fc" id="L78">        boolean validCredentials = DatabaseConnectorUser.checkIfUserAndPasswordExist(userToBeLoggedIn.getUsername(), userToBeLoggedIn.getPassword());</span>

        //Check if user is allowed to log in
<span class="fc bfc" id="L81" title="All 2 branches covered.">        if (!validCredentials) { //case that the credentials are invalid</span>
<span class="fc" id="L82">            boolean validUsername = DatabaseConnectorUser.checkIfUsernameExists(userToBeLoggedIn.getUsername());</span>
            //check if the username is valid, if yes, the password must be false
<span class="fc bfc" id="L84" title="All 2 branches covered.">            String message = validUsername ? &quot;Wrong password, please try again.&quot; : &quot;This username does not exist, please register first.&quot;;</span>
<span class="fc" id="L85">            throw new InvalidCredentialsException(message);</span>
        }

        //If credentials are valid set the user status to online, since the user will be logged in
<span class="fc" id="L89">        DatabaseConnectorUser.setOnlineStatus(userToBeLoggedIn, true);</span>
        //return new user representation
<span class="fc" id="L91">        User user = DatabaseConnectorUser.getUserByUsername(userToBeLoggedIn.getUsername());</span>

<span class="fc" id="L93">        return user;</span>
    }

    // creates a new user in the user repository
    public User createUser(User newUser) {
<span class="fc" id="L98">        newUser.setCreationDate(UserService.getCurrentDate());</span>
<span class="fc" id="L99">        newUser.setFavoriteLocations(new ArrayList&lt;Integer&gt;());</span>
        //Checks whether username is already taken
<span class="fc bfc" id="L101" title="All 2 branches covered.">        if (DatabaseConnectorUser.checkIfUsernameExists(newUser.getUsername())){</span>
<span class="fc" id="L102">            throw new DuplicatedUserException(&quot;The provided username is already taken. Please try a new one.&quot;);</span>
        }
        //If the username is not already taken create a new User in the database
<span class="fc" id="L105">        User userToReturn = DatabaseConnectorUser.createUser(newUser);</span>

<span class="fc" id="L107">        log.debug(&quot;Created Information for User: {}&quot;, newUser);</span>

<span class="fc" id="L109">        return userToReturn;</span>
    }

    // creates a timestamp of the current date for the creation date during the registration
    public static String getCurrentDate(){

<span class="fc" id="L115">        Date datenow = Calendar.getInstance().getTime();</span>
<span class="fc" id="L116">        DateFormat dateFormat = new SimpleDateFormat(&quot;dd.MM.yyyy&quot;);</span>
<span class="fc" id="L117">        Timestamp timestamp = new Timestamp(System.currentTimeMillis());</span>
<span class="fc" id="L118">        LocalDate date = LocalDate.now();</span>
        //return date.toString();
<span class="fc" id="L120">        return dateFormat.format(datenow);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>